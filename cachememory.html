<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cache Memory Simulation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #f4f4f4;
        }

        #simulation-controls {
            margin-bottom: 20px;
        }

        #output {
            width: 80%;
            margin-bottom: 20px;
            text-align: center;
        }

        .cache {
            display: flex;
            margin-bottom: 10px;
        }

        .cache-set {
            margin-right: 10px;
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
        }

        .memory {
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
        }

        button {
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
        }

        button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>

<div id="simulation-controls">
    <label for="memory-size">Memory Size:</label>
    <input type="number" id="memory-size" value="32">

    <label for="sets">Number of Sets:</label>
    <input type="number" id="sets" value="4">

    <label for="blocks-per-set">Blocks per Set:</label>
    <input type="number" id="blocks-per-set" value="8">

    <button onclick="simulateCache()">Simulate Cache Process</button>
</div>

<div id="output"></div>

<script>
    function simulateCache() {
        var memorySize = parseInt(document.getElementById('memory-size').value, 10);
        var sets = parseInt(document.getElementById('sets').value, 10);
        var blocksPerSet = parseInt(document.getElementById('blocks-per-set').value, 10);

        var cache = Array.from({ length: sets }, () => Array(blocksPerSet).fill(''));
        var lruStack = Array.from({ length: sets }, () => []);
        var memory = Array.from({ length: memorySize }, (_, index) => index + 1);

        var outputElement = document.getElementById('output');
        outputElement.innerHTML = '<strong>Output:</strong><br>';

        // Display cache sets
        for (var setIndex = 0; setIndex < cache.length; setIndex++) {
            outputElement.innerHTML += '<div class="cache">';
            for (var blockIndex = 0; blockIndex < cache[setIndex].length; blockIndex++) {
                outputElement.innerHTML += '<div class="cache-set">' + cache[setIndex][blockIndex] + '</div>';
            }
            outputElement.innerHTML += '</div>';
        }

        // Display memory
        outputElement.innerHTML += '<br><strong>Memory:</strong><br>';
        for (var i = 0; i < memory.length; i++) {
            outputElement.innerHTML += '<div class="memory">' + memory[i] + '</div>';
        }

        // Save log file to a folder
        saveLogFile(cache);

        // Simulate cache process
        for (var index = 0; index < memory.length; index++) {
            var val = memory[index];
            cacheProcess(cache, lruStack, val, index);
        }
    }

    function cacheProcess(cache, lruStack, val, index) {
        console.log(`\nindex ${index}: ${val}`);
        console.log("Cache:");
        for (var setIndex = 0; setIndex < cache.length; setIndex++) {
            console.log(`${cache[setIndex]}`);
        }

        if (cache.some(set => set.includes(val))) { // Value exists in cache
            console.log(`value ${val} is present in set ${cache.findIndex(set => set.includes(val))} block ${cache.flat().indexOf(val)}`);
            var cacheSet = cache.findIndex(set => set.includes(val));

            // Move existing value to the top of LRU stack
            lruStack[cacheSet].splice(lruStack[cacheSet].indexOf(val), 1);
            lruStack[cacheSet].push(val);
        } else { // Value does not exist in cache
            console.log(`value ${val} is not present in cache`);
            console.log(`index ${index} with value ${val} going to set ${index % cache.length}`);

            var cacheSet = index % cache.length;

            if (cache[cacheSet].some(block => block === '')) {
                console.log("Set is not full");
                var blockNum = cache[cacheSet].indexOf('');
                cache[cacheSet][blockNum] = val;
                console.log(`value ${val} placed in set ${cacheSet} block ${blockNum}`);
            } else {
                console.log("Set is full, therefore LRU");

                // Get index of LRU block from the bottom-most value and remove said value from the LRU stack
                var lruVal = lruStack[cacheSet][0];
                lruStack[cacheSet].splice(0, 1);
                var blockNum = cache[cacheSet].indexOf(lruVal);

                cache[cacheSet][blockNum] = val;
                console.log(`value ${val} placed in set ${cacheSet} block ${blockNum}`);
            }

            lruStack[cacheSet].push(val);
        }

        console.log("Updated Cache:");
        for (var setIndex = 0; setIndex < cache.length; setIndex++) {
            console.log(`${cache[setIndex]}`);
        }
    }

    function saveLogFile(cache) {
        var logContent = '';
        for (var setIndex = 0; setIndex < cache.length; setIndex++) {
            logContent += `Set ${setIndex}: ${cache[setIndex].toString()}\n`;
        }

        var blob = new Blob([logContent], { type: 'text/plain' });
        var fileName = 'Caching_Log.txt';
        var folderPath = 'logs/'; // Specify your desired folder path
        var downloadLink = document.createElement('a');

        downloadLink.href = window.URL.createObjectURL(blob);
        downloadLink.download = fileName;
        downloadLink.style.display = 'none';
        document.body.appendChild(downloadLink);

        downloadLink.click();

        document.body.removeChild(downloadLink);
    }
</script>

</body>
</html>
